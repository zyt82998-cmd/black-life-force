<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>é»‘è‰²ç”Ÿå‘½åŠ›</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --line:#222;
      --text:#fff;
      --muted:#bdbdbd;
      --ok:#49ff9a;
      --warn:#ffd24a;
      --no:#ff5b5b;
      --btn:#111;
      --btn2:#151515;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      padding:18px 14px 26px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    h1{margin:0; font-size:22px; letter-spacing:1px}
    .subtitle{color:var(--muted); font-size:13px; line-height:1.25}
    .pill{
      border:1px solid var(--line);
      background:var(--panel);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    nav{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:8px;
      margin:10px 0 14px;
    }
    .tab{
      padding:10px 8px;
      border-radius:12px;
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--muted);
      text-align:center;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      background:var(--btn2);
      color:var(--text);
      border-color:#333;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:12px;
    }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      background:#000;
      border:1px solid #333;
      color:var(--text);
      border-radius:12px;
      padding:11px 12px;
      font-size:15px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .btn{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #333;
      background:var(--btn2);
      color:var(--text);
      font-size:15px;
    }
    .btn.secondary{background:transparent; color:var(--muted)}
    .btn.danger{border-color:#402; background:#140000; color:#ffd0d0}
    .btn.small{width:auto; padding:8px 10px; font-size:13px; border-radius:999px}

    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .item{
      border:1px solid #2a2a2a;
      border-radius:12px;
      padding:10px 10px;
      background:#050505;
    }
    .meta{display:flex; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px}
    .text{margin-top:6px; white-space:pre-wrap; line-height:1.35}
    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tag{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #333;
      color:var(--muted);
      background:#090909;
    }
    .tag.ok{border-color:#1e4; color:var(--ok)}
    .tag.warn{border-color:#aa0; color:var(--warn)}
    .tag.no{border-color:#a22; color:var(--no)}
    .split{height:1px; background:var(--line); margin:12px 0}
    .hint{color:var(--muted); font-size:12px; line-height:1.35}
    .right{margin-left:auto}
    .hidden{display:none}
  </style>
</head>
<body>

<header>
  <div class="title">
    <h1>ğŸ–¤ é»‘è‰²ç”Ÿå‘½åŠ›</h1>
    <div class="subtitle">ä»Šå¤©ï¼Œæˆ‘åœ¨ä¸ºå“ªç§ç”Ÿå‘½åŠ›ä»˜å‡ºï¼Ÿ</div>
  </div>
  <div class="pill" id="todayPill"></div>
</header>

<nav>
  <div class="tab active" data-tab="ach">æˆå°±</div>
  <div class="tab" data-tab="mood">æƒ…ç»ª</div>
  <div class="tab" data-tab="money">èŠ±é’±</div>
  <div class="tab" data-tab="year">å¹´åæ ‡</div>
</nav>

<!-- æˆå°± -->
<section id="tab-ach">
  <div class="card">
    <div class="row">
      <div class="grow">
        <label>æˆ‘ä»Šå¤©å®Œæˆäº†ä»€ä¹ˆï¼Ÿï¼ˆä¸€å¥è¯å°±è¡Œï¼‰</label>
        <input id="achText" placeholder="ä¾‹å¦‚ï¼šå®Œæˆä¸€ä»½æŠ¥è¡¨ / å»å¾’æ­¥ / å†™äº†500å­—" />
      </div>
    </div>

    <label>è¿™ä»¶äº‹æ›´åƒå“ªç§ï¼Ÿ</label>
    <div class="row">
      <select id="achType">
        <option value="é»‘è‰²ç”Ÿå‘½åŠ›">ğŸ–¤ é»‘è‰²ç”Ÿå‘½åŠ›ï¼ˆé•¿æœŸä»·å€¼ï¼‰</option>
        <option value="ç§¯ç´¯å‹">ğŸŒ± ç§¯ç´¯å‹ï¼ˆæ…¢æ…¢å˜å¼ºï¼‰</option>
        <option value="å³æ—¶å®Œæˆ">âš¡ å³æ—¶å®Œæˆï¼ˆçŸ­æœŸçˆ½æ„Ÿï¼‰</option>
      </select>
      <button class="btn small" id="achToYearBtn" title="ä¸‹ä¸€æ¡æˆå°±å°†åŒæ—¶åŠ å…¥å¹´åº¦åæ ‡">åŠ å…¥å¹´åº¦</button>
      <span class="hint">ç‚¹ä¸€æ¬¡â€œåŠ å…¥å¹´åº¦â€ï¼Œæœ¬æ¡æˆå°±ä¼šè¿›ä»Šå¹´çš„åæ ‡è½´ã€‚</span>
    </div>

    <div style="margin-top:12px" class="row">
      <button class="btn" id="achSave">è®°å½•æˆå°±</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="grow">
        <div class="hint">æˆå°±ä¸æ˜¯å¾…åŠï¼Œæ˜¯<strong>å·²å®Œæˆ</strong>ã€‚ä½ åªè¦ç•™ä¸‹â€œæˆ‘åšæˆäº†ä»€ä¹ˆâ€ã€‚</div>
      </div>
      <button class="btn small danger" id="achClear">æ¸…ç©ºæˆå°±</button>
    </div>
    <div class="list" id="achList"></div>
  </div>
</section>

<!-- æƒ…ç»ª -->
<section id="tab-mood" class="hidden">
  <div class="card">
    <label>å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ</label>
    <textarea id="mEvent" placeholder="ä¾‹å¦‚ï¼šä»–æ²¡å›æ¶ˆæ¯ / å·¥ä½œè¢«å‚¬ / å®¶é‡Œäº‰æ‰§"></textarea>

    <label>å®ƒè®©æˆ‘äº§ç”Ÿäº†ä»€ä¹ˆæƒ…ç»ªï¼Ÿ</label>
    <select id="mFeeling">
      <option value="ç„¦è™‘">ç„¦è™‘</option>
      <option value="å§”å±ˆ">å§”å±ˆ</option>
      <option value="æ„¤æ€’">æ„¤æ€’</option>
      <option value="ç©º">ç©º</option>
      <option value="æ‚²ä¼¤">æ‚²ä¼¤</option>
      <option value="å¹³é™">å¹³é™</option>
      <option value="æœ‰åŠ›é‡">æœ‰åŠ›é‡</option>
    </select>

    <label>æˆ‘æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</label>
    <select id="mHandle">
      <option value="è¿˜æ²¡å¤„ç†">è¿˜æ²¡å¤„ç†</option>
      <option value="é€ƒé¿äº†">é€ƒé¿äº†</option>
      <option value="ç¡¬æ‰›">ç¡¬æ‰›</option>
      <option value="è§£å†³äº†">è§£å†³äº†</option>
      <option value="æ¥å—äº†">æ¥å—äº†</option>
      <option value="è½¬ç§»äº†">è½¬ç§»äº†</option>
    </select>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="mSave">è®°å½•æƒ…ç»ª</button>
      <button class="btn small" id="mToYearBtn">æœ¬æ¡åŠ å…¥å¹´åº¦</button>
    </div>
    <div class="hint" style="margin-top:8px">â€œåŠ å…¥å¹´åº¦â€é€‚åˆï¼šèƒ½ä»£è¡¨ä½ ä»Šå¹´å…³ç³»/æƒ…ç»ªæ¨¡å¼çš„ä¸€æ¡ã€‚</div>
  </div>

  <div class="card">
    <div class="row">
      <div class="grow hint">ä½ ä¸æ˜¯è¦å˜â€œæ›´å¥½â€ï¼Œä½ æ˜¯è¦å˜â€œæ›´æ‡‚è‡ªå·±â€ã€‚</div>
      <button class="btn small danger" id="mClear">æ¸…ç©ºæƒ…ç»ª</button>
    </div>
    <div class="list" id="mList"></div>
  </div>
</section>

<!-- èŠ±é’± -->
<section id="tab-money" class="hidden">
  <div class="card">
    <label>èŠ±äº†å¤šå°‘é’±ï¼Ÿ</label>
    <input id="pAmount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š58.5" />

    <label>èŠ±åœ¨ä»€ä¹ˆä¸Šï¼Ÿ</label>
    <input id="pWhat" placeholder="ä¾‹å¦‚ï¼šè¯ / å¤–å– / è¯¾ç¨‹ / äº¤é€š" />

    <label>è¿™ç¬”é’±å¯¹æˆ‘æ¥è¯´ï¼š</label>
    <select id="pWorth">
      <option value="å¯ä¸èŠ±">âŒ å¯ä¸èŠ±</option>
      <option value="ä¸­æ€§">âš ï¸ ä¸­æ€§</option>
      <option value="å€¼å¾—èŠ±">âœ… å€¼å¾—èŠ±</option>
    </select>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="pSave">è®°å½•èŠ±é’±</button>
      <button class="btn small" id="pToYearBtn">æœ¬æ¡åŠ å…¥å¹´åº¦</button>
    </div>

    <div class="split"></div>

    <div class="row">
      <div class="grow">
        <div class="hint"><strong>æœ¬æœˆèŠ±è´¹æ±‡æ€»</strong></div>
        <div class="hint" id="monthSummary">â€”</div>
      </div>
      <button class="btn small secondary" id="refreshMonth">åˆ·æ–°</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="grow hint">ä½ ä¸æ˜¯ä¸ºäº†æŠ ï¼Œè€Œæ˜¯ä¸ºäº†æ‹¥æœ‰â€œé€‰æ‹©æ„Ÿâ€ã€‚</div>
      <button class="btn small danger" id="pClear">æ¸…ç©ºèŠ±é’±</button>
    </div>
    <div class="list" id="pList"></div>
  </div>
</section>

<!-- å¹´åæ ‡ -->
<section id="tab-year" class="hidden">
  <div class="card">
    <div class="row">
      <div class="grow">
        <div class="hint"><strong>å¹´åº¦åæ ‡è½´</strong>ï¼šç•™ä¸‹èƒ½ä»£è¡¨ä»Šå¹´çš„äº‹ã€‚</div>
        <div class="hint" id="yearHint"></div>
      </div>
      <button class="btn small secondary" id="exportBtn">å¯¼å‡º</button>
      <button class="btn small secondary" id="importBtn">å¯¼å…¥</button>
      <button class="btn small danger" id="yClear">æ¸…ç©ºå¹´åº¦</button>
    </div>

    <div class="split"></div>
    <div class="hint">ä½ å¯ä»¥æŠŠâ€œæˆå°±/æƒ…ç»ª/èŠ±é’±â€çš„æŸä¸€æ¡ç‚¹è¿›å¹´åº¦ã€‚å¹´åº¦åªéœ€è¦å°‘è€Œç²¾ã€‚</div>
    <div class="list" id="yList"></div>

    <input id="fileInput" type="file" accept="application/json" class="hidden" />
  </div>
</section>

<script>
  // ---------- åŸºç¡€å·¥å…· ----------
  const $ = (id) => document.getElementById(id);
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const todayKey = `${yyyy}-${mm}-${dd}`;
  $('todayPill').textContent = `${yyyy}å¹´${mm}æœˆ${dd}æ—¥`;

  const KEYS = {
    ach: 'blf_achievements_v1',
    mood: 'blf_moods_v1',
    pay: 'blf_payments_v1',
    year: 'blf_year_v1'
  };

  function load(key){
    try{ return JSON.parse(localStorage.getItem(key) || '[]'); }
    catch(e){ return []; }
  }
  function save(key, arr){
    localStorage.setItem(key, JSON.stringify(arr));
  }
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function fmtDate(d){
    // d is yyyy-mm-dd
    return d.replaceAll('-', '/');
  }
  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ---------- Tabs ----------
  const tabs = document.querySelectorAll('.tab');
  const sections = {
    ach: $('tab-ach'),
    mood: $('tab-mood'),
    money: $('tab-money'),
    year: $('tab-year')
  };
  function openTab(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    Object.entries(sections).forEach(([k,el]) => el.classList.toggle('hidden', k !== name));
    if(name === 'money') updateMonthSummary();
    if(name === 'year') updateYearHint();
  }
  tabs.forEach(t => t.addEventListener('click', ()=>openTab(t.dataset.tab)));

  // ---------- æ¸²æŸ“ ----------
  function renderAchievements(){
    const arr = load(KEYS.ach).slice().reverse();
    const box = $('achList');
    box.innerHTML = arr.length ? '' : `<div class="hint">è¿˜æ²¡æœ‰æˆå°±è®°å½•ã€‚å…ˆè®°å½•ä¸€æ¡â€œæˆ‘åšæˆäº†ä»€ä¹ˆâ€ã€‚</div>`;
    arr.forEach(x=>{
      box.innerHTML += `
        <div class="item">
          <div class="meta"><span>${fmtDate(x.date)}</span><span>${escapeHtml(x.type)}</span></div>
          <div class="text">${escapeHtml(x.text)}</div>
          <div class="tags">
            <span class="tag ${x.toYear?'ok':''}">${x.toYear?'å·²åŠ å…¥å¹´åº¦':'æœªåŠ å…¥å¹´åº¦'}</span>
          </div>
        </div>`;
    });
  }

  function renderMoods(){
    const arr = load(KEYS.mood).slice().reverse();
    const box = $('mList');
    box.innerHTML = arr.length ? '' : `<div class="hint">è¿˜æ²¡æœ‰æƒ…ç»ªè®°å½•ã€‚å†™ä¸‹â€œå‘ç”Ÿäº†ä»€ä¹ˆ â†’ æƒ…ç»ª â†’ å¤„ç†æ–¹å¼â€ã€‚</div>`;
    arr.forEach(x=>{
      box.innerHTML += `
        <div class="item">
          <div class="meta"><span>${fmtDate(x.date)}</span><span>${escapeHtml(x.feeling)} Â· ${escapeHtml(x.handle)}</span></div>
          <div class="text">${escapeHtml(x.event)}</div>
          <div class="tags">
            <span class="tag ${x.toYear?'ok':''}">${x.toYear?'å·²åŠ å…¥å¹´åº¦':'æœªåŠ å…¥å¹´åº¦'}</span>
          </div>
        </div>`;
    });
  }

  function renderPayments(){
    const arr = load(KEYS.pay).slice().reverse();
    const box = $('pList');
    box.innerHTML = arr.length ? '' : `<div class="hint">è¿˜æ²¡æœ‰èŠ±é’±è®°å½•ã€‚è®°ä¸€ç¬”â€œå¤šå°‘é’± + èŠ±åœ¨ä»€ä¹ˆ + å€¼ä¸å€¼å¾—â€ã€‚</div>`;
    arr.forEach(x=>{
      const cls = x.worth === 'å€¼å¾—èŠ±' ? 'ok' : (x.worth === 'ä¸­æ€§' ? 'warn' : 'no');
      box.innerHTML += `
        <div class="item">
          <div class="meta"><span>${fmtDate(x.date)}</span><span>Â¥${Number(x.amount).toFixed(2)}</span></div>
          <div class="text">${escapeHtml(x.what)}</div>
          <div class="tags">
            <span class="tag ${cls}">${escapeHtml(x.worth)}</span>
            <span class="tag ${x.toYear?'ok':''}">${x.toYear?'å·²åŠ å…¥å¹´åº¦':'æœªåŠ å…¥å¹´åº¦'}</span>
          </div>
        </div>`;
    });
  }

  function renderYear(){
    const arr = load(KEYS.year).slice().reverse();
    const box = $('yList');
    box.innerHTML = arr.length ? '' : `<div class="hint">å¹´åº¦åæ ‡è¿˜æ˜¯ç©ºçš„ã€‚ä½ å¯ä»¥ä»â€œæˆå°±/æƒ…ç»ª/èŠ±é’±â€é‡ŒæŠŠä»£è¡¨æ€§çš„æ¡ç›®åŠ å…¥è¿›æ¥ã€‚</div>`;
    arr.forEach(x=>{
      const tag = x.kind === 'æˆå°±' ? 'ok' : (x.kind === 'èŠ±é’±' ? 'warn' : '');
      box.innerHTML += `
        <div class="item">
          <div class="meta"><span>${fmtDate(x.date)}</span><span>${escapeHtml(x.kind)}</span></div>
          <div class="text">${escapeHtml(x.text)}</div>
          ${x.extra ? `<div class="tags"><span class="tag ${tag}">${escapeHtml(x.extra)}</span></div>` : ''}
        </div>`;
    });
  }

  // ---------- æˆå°± ----------
  let nextAchToYear = false;
  $('achToYearBtn').addEventListener('click', ()=>{
    nextAchToYear = !nextAchToYear;
    $('achToYearBtn').textContent = nextAchToYear ? 'å·²é€‰å¹´åº¦' : 'åŠ å…¥å¹´åº¦';
    $('achToYearBtn').style.borderColor = nextAchToYear ? '#3a3' : '#333';
  });

  $('achSave').addEventListener('click', ()=>{
    const text = $('achText').value.trim();
    if(!text){ alert('å…ˆå†™ä¸€å¥ï¼šæˆ‘ä»Šå¤©å®Œæˆäº†ä»€ä¹ˆ'); return; }
    const type = $('achType').value;
    const arr = load(KEYS.ach);
    const item = { id: uid(), date: todayKey, text, type, toYear: nextAchToYear };
    arr.push(item); save(KEYS.ach, arr);

    if(nextAchToYear){
      const y = load(KEYS.year);
      y.push({ id: uid(), date: todayKey, kind:'æˆå°±', text: `${type}ï½œ${text}`, extra: type });
      save(KEYS.year, y);
    }

    $('achText').value = '';
    nextAchToYear = false;
    $('achToYearBtn').textContent = 'åŠ å…¥å¹´åº¦';
    $('achToYearBtn').style.borderColor = '#333';

    renderAchievements(); renderYear(); updateYearHint();
    alert('å·²è®°å½• ğŸ–¤');
  });

  $('achClear').addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æˆå°±è®°å½•ï¼Ÿ')){
      save(KEYS.ach, []);
      renderAchievements();
    }
  });

  // ---------- æƒ…ç»ª ----------
  let nextMoodToYear = false;
  $('mToYearBtn').addEventListener('click', ()=>{
    nextMoodToYear = !nextMoodToYear;
    $('mToYearBtn').textContent = nextMoodToYear ? 'å·²é€‰å¹´åº¦' : 'æœ¬æ¡åŠ å…¥å¹´åº¦';
    $('mToYearBtn').style.borderColor = nextMoodToYear ? '#3a3' : '#333';
  });

  $('mSave').addEventListener('click', ()=>{
    const event = $('mEvent').value.trim();
    if(!event){ alert('å…ˆå†™ï¼šå‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ'); return; }
    const feeling = $('mFeeling').value;
    const handle = $('mHandle').value;

    const arr = load(KEYS.mood);
    const item = { id: uid(), date: todayKey, event, feeling, handle, toYear: nextMoodToYear };
    arr.push(item); save(KEYS.mood, arr);

    if(nextMoodToYear){
      const y = load(KEYS.year);
      y.push({ id: uid(), date: todayKey, kind:'æƒ…ç»ª', text: `äº‹ä»¶ï¼š${event}\næƒ…ç»ªï¼š${feeling}\nå¤„ç†ï¼š${handle}`, extra: `${feeling}Â·${handle}` });
      save(KEYS.year, y);
    }

    $('mEvent').value = '';
    nextMoodToYear = false;
    $('mToYearBtn').textContent = 'æœ¬æ¡åŠ å…¥å¹´åº¦';
    $('mToYearBtn').style.borderColor = '#333';

    renderMoods(); renderYear(); updateYearHint();
    alert('å·²è®°å½• ğŸ–¤');
  });

  $('mClear').addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æƒ…ç»ªè®°å½•ï¼Ÿ')){
      save(KEYS.mood, []);
      renderMoods();
    }
  });

  // ---------- èŠ±é’± ----------
  let nextPayToYear = false;
  $('pToYearBtn').addEventListener('click', ()=>{
    nextPayToYear = !nextPayToYear;
    $('pToYearBtn').textContent = nextPayToYear ? 'å·²é€‰å¹´åº¦' : 'æœ¬æ¡åŠ å…¥å¹´åº¦';
    $('pToYearBtn').style.borderColor = nextPayToYear ? '#3a3' : '#333';
  });

  $('pSave').addEventListener('click', ()=>{
    const amountStr = $('pAmount').value.trim();
    const what = $('pWhat').value.trim();
    if(!amountStr || isNaN(Number(amountStr))){ alert('å…ˆå¡«æ­£ç¡®é‡‘é¢ï¼ˆæ•°å­—ï¼‰'); return; }
    if(!what){ alert('å…ˆå†™ï¼šèŠ±åœ¨ä»€ä¹ˆä¸Š'); return; }

    const worth = $('pWorth').value;
    const amount = Number(amountStr);

    const arr = load(KEYS.pay);
    const item = { id: uid(), date: todayKey, amount, what, worth, toYear: nextPayToYear };
    arr.push(item); save(KEYS.pay, arr);

    if(nextPayToYear){
      const y = load(KEYS.year);
      y.push({ id: uid(), date: todayKey, kind:'èŠ±é’±', text: `Â¥${amount.toFixed(2)}ï½œ${what}ï½œ${worth}`, extra: worth });
      save(KEYS.year, y);
    }

    $('pAmount').value = '';
    $('pWhat').value = '';
    nextPayToYear = false;
    $('pToYearBtn').textContent = 'æœ¬æ¡åŠ å…¥å¹´åº¦';
    $('pToYearBtn').style.borderColor = '#333';

    renderPayments(); renderYear(); updateMonthSummary(); updateYearHint();
    alert('å·²è®°å½• ğŸ–¤');
  });

  $('refreshMonth').addEventListener('click', updateMonthSummary);

  $('pClear').addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰èŠ±é’±è®°å½•ï¼Ÿ')){
      save(KEYS.pay, []);
      renderPayments();
      updateMonthSummary();
    }
  });

  function updateMonthSummary(){
    const arr = load(KEYS.pay);
    const prefix = `${yyyy}-${mm}-`;
    const monthArr = arr.filter(x => (x.date || '').startsWith(prefix));
    const sum = monthArr.reduce((a,x)=>a+(Number(x.amount)||0),0);
    const worth = monthArr.filter(x=>x.worth==='å€¼å¾—èŠ±').reduce((a,x)=>a+(Number(x.amount)||0),0);
    const no = monthArr.filter(x=>x.worth==='å¯ä¸èŠ±').reduce((a,x)=>a+(Number(x.amount)||0),0);
    $('monthSummary').textContent =
      monthArr.length
      ? `æœ¬æœˆè®°å½• ${monthArr.length} ç¬”ï½œæ€»è®¡ Â¥${sum.toFixed(2)}ï½œå€¼å¾—èŠ± Â¥${worth.toFixed(2)}ï½œå¯ä¸èŠ± Â¥${no.toFixed(2)}`
      : 'æœ¬æœˆè¿˜æ²¡æœ‰èŠ±é’±è®°å½•ã€‚';
  }

  // ---------- å¹´åæ ‡ ----------
  function updateYearHint(){
    const y = load(KEYS.year);
    $('yearHint').textContent = `ä»Šå¹´ï¼ˆ${yyyy}ï¼‰å·²æ”¶å½• ${y.length} æ¡ã€‚`;
  }

  $('yClear').addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºå¹´åº¦åæ ‡ï¼Ÿï¼ˆä¸ä¼šæ¸…ç©ºæˆå°±/æƒ…ç»ª/èŠ±é’±åŸå§‹è®°å½•ï¼‰')){
      save(KEYS.year, []);
      renderYear();
      updateYearHint();
    }
  });

  // å¯¼å‡º/å¯¼å…¥ï¼ˆé˜²æ­¢ä½ ä»¥åæ¢æ‰‹æœºä¸¢æ•°æ®ï¼‰
  $('exportBtn').addEventListener('click', ()=>{
    const data = {
      version:'blf_v1',
      exportedAt: new Date().toISOString(),
      achievements: load(KEYS.ach),
      moods: load(KEYS.mood),
      payments: load(KEYS.pay),
      year: load(KEYS.year)
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `é»‘è‰²ç”Ÿå‘½åŠ›_${yyyy}${mm}${dd}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  $('importBtn').addEventListener('click', ()=> $('fileInput').click());

  $('fileInput').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!obj || obj.version !== 'blf_v1') throw new Error('æ–‡ä»¶æ ¼å¼ä¸å¯¹');
      save(KEYS.ach, obj.achievements||[]);
      save(KEYS.mood, obj.moods||[]);
      save(KEYS.pay, obj.payments||[]);
      save(KEYS.year, obj.year||[]);
      renderAchievements(); renderMoods(); renderPayments(); renderYear();
      updateMonthSummary(); updateYearHint();
      alert('å¯¼å…¥æˆåŠŸ ğŸ–¤');
    }catch(err){
      alert('å¯¼å…¥å¤±è´¥ï¼šè¯·ç¡®è®¤ä½ é€‰çš„æ˜¯å¯¼å‡ºçš„jsonæ–‡ä»¶');
    }finally{
      e.target.value = '';
    }
  });

  // ---------- åˆå§‹åŒ– ----------
  renderAchievements();
  renderMoods();
  renderPayments();
  renderYear();
  updateMonthSummary();
  updateYearHint();

  // ---------- æ³¨å†Œ Service Workerï¼ˆç¦»çº¿ï¼‰ ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }
</script>
</body>
</html>
